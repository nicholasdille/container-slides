<?xml version="1.0" encoding="ISO-8859-1" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"/>

<title>Webinar: Monitoring Kubernetes and Cloud Native Apps</title>

<!-- https://gauger.io/fonticon/ -->
<link rel="icon" href="images/camera.ico"/>

<link rel="stylesheet" href="media/reveal.js@4.3.1/dist/reveal.css"/>
<link rel="stylesheet" href="media/reveal.js@4.3.1/dist/theme/black.css" id="theme"/>
<link rel="stylesheet" href="themes/theme2022.css" id="theme"/>
<link rel="stylesheet" href="themes/common.css"/>
<link rel="stylesheet" href="media/highlight.js@11.5.0/styles/rainbow.css"/>
<link rel="stylesheet" href="media/fontawesome-pro@6.2.0/css/all.min.css"/>
<link rel="stylesheet" href="media/notyf@3.10.0/notyf.min.css"/>
</head>

<body>
<div class="reveal">
<div class="slides">

<section data-markdown="" data-separator="^---$" data-separator-vertical="^--$"><textarea data-template="">
<!-- .slide: data-background="images/tobias-tullius-Q2-EQDwxFtw-unsplash.jpg" class="vertical-center" style="padding: 1em 1em 1em 1em; color: white; background: rgba(0, 0, 0, 0.5); width: 90%; margin: auto;" -->

# Monitoring Kubernetes and Cloud Native Apps

Nicholas Dille, Haufe.Group

<i class="fa-brands fa-docker" style="width: 1.5em; text-align: center;"></i> Docker Captain

<i class="fa-brands fa-windows" style="width: 1.5em; text-align: center;"></i> Microsoft MVP

<i class="fa-brands fa-twitter" style="width: 1.5em; text-align: center;"></i> @nicholasdille
    </textarea></section>

    <section data-markdown="000_introduction/02_bio.md" data-separator="^---$" data-separator-vertical="^--$"></section>

    <section data-markdown="" data-separator="^---$" data-separator-vertical="^--$"><textarea data-template="">
## Agenda

| From  | To    | What           |
|-------|-------|----------------|
| 09:00 |       | Let's roll     |
| 10:45 | 11:00 | Coffee Break   |
| 11:00 | 12:30 | Let's continue |
| 12:30 | 13:00 | Q&amp;A        |
|       | 13:00 | The End        |
    </textarea></section>

    <section data-markdown="" data-separator="^---$" data-separator-vertical="^--$"><textarea data-template="">
## Agenda topics

- <span class="fa-li"><i class="fa-duotone fa-binoculars"></i></span> Observability *o11y*
- <span class="fa-li"><i class="fa-duotone fa-person-dolly-empty"></i></span> Collection strategies
- <span class="fa-li"><i class="fa-duotone fa-layer-group"></i></span> Layers of Monitoring
- <span class="fa-li"><i class="fa-duotone fa-chart-line"></i></span> Visualization
- <span class="fa-li"><i class="fa-duotone fa-person-chalkboard"></i></span> Lessons Learnt from Monitoring

<!-- .element: class="fa-ul" -->

---

## o11y

Observability helps understanding a system from the outside

It consists of three pillars

### <i class="fa-duotone fa-chart-line"></i> Metrics

Quantative measures of performance data

### <i class="fa-duotone fa-file-lines"></i> Logs

Protocol of status information and events during runtime

### <i class="fa-duotone fa-shoe-prints"></i> Distributed Traces

Metadata for status information

Connect protocols across services

---

## Metric sources

![](100_monitoring/prometheus/layers.drawio.svg)<!-- .element: style="width: 50%;" -->

<!-- .element: style="width: 90%;" -->

---

## Collection strategies

XXX

![](100_monitoring/prometheus/push.drawio.svg) <!-- .element: style="width: 45%; float: right;" -->

### Push <i class="fa-duotone fa-truck"></i>

Metrics are delivered to database

Example: Telegraf agent and InfluxDB

### Pull <i class="fa-duotone fa-hand-holding-heart"></i>

![](100_monitoring/prometheus/pull.drawio.svg) <!-- .element: style="width:45%; float: right;" -->

Database scrapes metrics

Example: Exporters and Prometheus

---

## Scope

![](100_monitoring/prometheus/logo.svg) <!-- .element: style="float: right; width: 4em;" -->

Prometheus [](https://prometheus.io/) for cloud native monitoring

Graduated project of CNCF [](https://www.cncf.io/projects/prometheus/)

### Internals

![](100_monitoring/prometheus/prometheus.drawio.svg) <!-- .element: style="float: right; width: 50%;" -->

Exporters offer metrics for retrieval

Prometheus scrapes data from exporters

Metrics are stored in a time series database (TSDB)

Query language PromQL

---

## Container metrics primer

Collecting metrics for containers

Containers are based on cgroups

Start a container and retrieve ID:

```bash
docker run -d --name nginx nginx
ID="$(docker container inspect nginx | jq -r '.[].Id')""
```

Using high-level tools:

```bash
docker stats
systemd-cgtop
```

Directly from the kernel:

```bash
cat "/sys/fs/cgroup/pids/docker/${ID}/cgroup.procs"
cat "/sys/fs/cgroup/cpuacct/docker/${ID}/cpuacct.usage"
cat "/sys/fs/cgroup/memory/docker/${ID}/memory.usage_in_bytes"
```

---

## Container metrics in Kubernetes

Remember: `kubelet` is responsible for maintaining pods/containers on a node

kubelet collects metrics

Published under /metrics/cadvisor/

`kubectl top` requires metrics server https://github.com/kubernetes-sigs/metrics-server/

---

## Demo: Container metrics in Kubernetes 1/

Explore metrics using `kubeletctl` [](https://github.com/cyberark/kubeletctl)

```bash
IP="$(
    docker inspect \
        --format '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}'
        kind-worker
)"
TOKEN="$(
    kubectl get secrets kubelet -o json \
    | jq --raw-output '.data.token' \
    | base64 -d
)"
kubectl get secrets kubelet -o json \
| jq --raw-output '.data."ca.crt"' \
| base64 -d >ca.crt
kubeletctl \
    --server ${IP} \
    --cacert ca.crt \
    --token ${TOKEN} \
    metrics cadvisor | less
```

---

## Demo: Container metrics in Kubernetes 2/

Explore metrics using `curl`

```bash
IP="$(
    docker inspect \
        --format '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}'
        kind-worker
)"
TOKEN="$(
    kubectl get secrets kubelet -o json \
    | jq --raw-output '.data.token' \
    | base64 -d
)"
kubectl get secrets kubelet -o json \
| jq --raw-output '.data."ca.crt"' \
| base64 -d >ca.crt
curl -skH "Authorization: Bearer ${TOKEN}" \
    "https://${IP}:10250/metrics/cadvisor" | less
curl -skH "Authorization: Bearer ${TOKEN}" \
    "https://${IP}:10250/metrics/cadvisor" | grep container_memory_usage_bytes | grep kube-proxy
```

---

## OpenMetrics 1/

"...today's de-facto standard for transmitting cloud-native metrics at scale."

### Types


- <span class="fa-li"><i class="fa-duotone fa-gauge-high"></i></span> Gauge
- <span class="fa-li"><i class="fa-duotone fa-arrow-down-1-9"></i></span> Counter
- <span class="fa-li"><i class="fa-duotone fa-chart-column"></i></span> Histogram

<!-- .element: class="fa-ul" -->

XXX more?

### Metadata

Metrics can have labels

Labels provide metadata for filtering

---

### OpenMetrics 2/2

```plaintext
# TYPE acme_http_router_request_seconds summary
# UNIT acme_http_router_request_seconds seconds
# HELP acme_http_router_request_seconds Latency though all of ACME's HTTP request router.
acme_http_router_request_seconds_sum{path="/api/v1",method="GET"} 9036.32
acme_http_router_request_seconds_count{path="/api/v1",method="GET"} 807283.0
acme_http_router_request_seconds_created{path="/api/v1",method="GET"} 1605281325.0
acme_http_router_request_seconds_sum{path="/api/v2",method="POST"} 479.3
acme_http_router_request_seconds_count{path="/api/v2",method="POST"} 34.0
acme_http_router_request_seconds_created{path="/api/v2",method="POST"} 1605281325.0
# TYPE go_goroutines gauge
# HELP go_goroutines Number of goroutines that currently exist.
go_goroutines 69
# TYPE process_cpu_seconds counter
# UNIT process_cpu_seconds seconds
# HELP process_cpu_seconds Total user and system CPU time spent in seconds.
process_cpu_seconds_total 4.20072246e+06
# EOF
```

---

## Host metrics

Can containers use all resources? Yes, but they should not!

### Operating system

XXX

### Kubernetes

XXX

XXX image

https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/

https://learnk8s.io/kubernetes-instance-calculator

https://github.com/learnk8s/kubernetes-resource-inspector

---

## CPU Reservations in Managed Kubernetes

Major cloud providers agree

| Cores | Reservation    | Cumulative | Efficiency |
|-------|---------------:|-----------:|-----------:|
| 1     |   60m          | 60m        | 94.0%      |
| 2     | + 10m          | 70m        | 96.5%      |
| 4     | + 10m          | 80m        | 98.0%      |
| 8     | + 10m          | 90m        | 99.0%      |

### Rules

6% of first core, 1% of second core, 0.5% of third and fourth core, 0.25% per core > 4

---

## Memory reservations in Managed Kubernetes

Most major cloud providers agree

AWS uses: 255MiB + 11MiB * MAX_PODS

| Memory | Reservation | Cumulative | Efficiency |
|--------|------------:|-----------:|-----------:|
| 0      |   255MiB    | 255MiB     |            |
| 4GiB   | + 800MiB    | 1055MiB    | 73.7%      |
| 8GiB   | + 800GiB    | 1855MiB    | 76,8%      |
| 112GiB | + 672MiB    | 2527MiB    | 97.7%      |
| 128GiB | + 256MiB    | 2783MiB    | 97.8%      |

### Rules

255MiB, 25% of 4GiB, 20% of next 4GiB, 10% of next 8GiB, 6% of next 112GiB, 2% of memory above 128GiB

---

## Host metrics collection

node-exporter collect metrics...

...and exports them for scraping

XXX what metrics

### Demo

Start Kubernetes API proxy:

```bash
kubectl proxy
```

Read metrics endpoint:

```bash
curl localhost:8001/api/v1/namespaces/kube-system/services/node-exporter-prometheus-node-exporter:metrics/proxy/metrics
```

---

## Cluster metrics

All components provide a metrics endpoint

Prometheus should scrape all of them

---

## metrics-server [](https://github.com/kubernetes-sigs/metrics-server/)

Required for `kubectl top`

Collected metrics

Required for Horizontal/Vertical Pod AutoScaler

`kubectl get --raw /apis/metrics.k8s.io/v1beta1/nodes/kind-worker | jq`

`kubectl get --raw /apis/metrics.k8s.io/v1beta1/namespaces/kube-system/pods/etcd-kind-control-plane | jq`

`kubectl top`

---

### `kube-state-metrics` [](https://github.com/kubernetes/kube-state-metrics)

New metrics about cluster

https://www.datadoghq.com/blog/monitoring-kubernetes-performance-metrics/

`kubectl proxy`

`curl localhost:8001/api/v1/namespaces/kube-system/services/kube-state-metrics:http/proxy/metrics`

---

## Metrics collection

XXX image with Prometheus, cluster components, metrics-server, kube-state-metrics, kubectl

---

## Scrape configuration

Read from app with metrics endpoints

Read from central exporter which reads from app

Read from app with exporter sidecar

XXX

---

## Prometheus Operator

XXX deploy

XXX configure!

ServiceMonitor / PodMonitor

Scraping-as-Code

## Demo

Deploy

(Pod|Service)Monitors for cluster components

Targets

Graph

---

## PromQL

XXX

promtool https://github.com/prometheus/prometheus/tree/main/cmd/promtool

PromQL https://prometheus.io/docs/prometheus/latest/querying/basics/

PromQL CLI https://github.com/nalbury/promql-cli

---

## Visualization

Grafana

Datasource

PromQL

### Demo

Graph for memory

Graph for CPU (usage)

Count running containers

https://github.com/kubernetes-monitoring/kubernetes-mixin

---

## Special exporters

### `blackbox-exporter` [](https://github.com/prometheus/blackbox_exporter)

XXX

### `json-exporter` []()

XXX

### `pushgateway` [](https://github.com/prometheus/pushgateway)

Helps with firewall traversal

Accepts metrics from apps or agents

Does not remove orphaned metrics

No data?

XXX https://github.com/prometheus/pushgateway#command-line

---

## Pod Quality-of-Service

Pod Eviction

Pod QoS https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/

Resource requests/limits

Scheduling/eviction

---

## Outlook

[Federation](https://prometheus.io/docs/prometheus/latest/federation/) of multiple clusters

Scaling
- [Thanos](https://thanos.io/)
- [Cortex](https://cortexmetrics.io/)
- [Mimir](https://grafana.com/oss/mimir/)

Log shipping
- [ElasticSearch](https://www.elastic.co/)
- [Loki](https://grafana.com/oss/loki/)

Tracing
- [Sentry](https://sentry.io/)
- [Jaeger](https://www.jaegertracing.io/)
- [Tempo](https://grafana.com/oss/tempo/)
</textarea></section>

    <section data-markdown="" data-separator="^---$" data-separator-vertical="^--$"><textarea data-template="">
## Summary

<ul class="fa-ul">
<li><span class="fa-li"><i class="fa-duotone fa-chart-line"></i></span> Metrics are just one aspect of o11y</li>
<li><span class="fa-li"><i class="fa-duotone fa-lightbulb-on"></i></span> Prometheus is a natural choice for Kubernetes</li>
<li><span class="fa-li"><i class="fa-duotone fa-layer-group"></i></span> Metrics must be collected on many levels</li>
<li><span class="fa-li"><i class="fa-duotone fa-shield-check"></i></span> Pod resources can protect from eviction</li>

### Upcoming talks / other content

2022-12-01 [Sicherheit im Kubernetes-Cluster](https://webinare.heise.de/kubernetes/security-im-kubernetes-cluster/)

Video-Kurs [Container-Orchestrierung mit Kubernetes leicht gemacht](https://shop.heise-academy.de/kubernetes-container-orchestrierung-leicht-gemacht)
</ul>
</textarea></section>

</div>
</div>

<script src="media/reveal.js@4.3.1/dist/reveal.js" type="application/javascript"></script>
<script src="media/reveal.js@4.3.1/plugin/markdown/markdown.js" type="application/javascript"></script>
<script src="media/reveal.js@4.3.1/plugin/highlight/highlight.js" type="application/javascript"></script>
<script src="media/reveal.js@4.3.1/plugin/search/search.js" type="application/javascript"></script>
<script src="media/reveal.js@4.3.1/plugin/zoom/zoom.js" type="application/javascript"></script>
<script src="media/reveal.js@4.3.1/plugin/notes/notes.js" type="application/javascript"></script>
<script src="media/clipboard@2.0.11/dist/clipboard.js" type="application/javascript"></script>
<script src="media/notyf@3.10.0/notyf.min.js" type="application/javascript"></script>
<script>
var durationInMinutes = 4 * 60;
Reveal.initialize({
    width: 1920,
    height: 1080,
    margin: 0.05,
    minScale: 0.2,
    maxScale: 2.0,
    controlsTutorial: false,
    showSlideNumber: false,
    hash: true,
    history: true,
    keyboard: true,
    overview: true,
    center: false,
    touch: false,
    shuffle: false,
    fragments: true,
    fragmentInURL: true,
    embedded: false,
    help: true,
    showNotes: false,
    autoPlayMedia: null,
    mouseWheel: false,
    previewLinks: false,
    transition: 'convex',
    transitionSpeed: 'default',
    backgroundTransition: 'fade',
    hideInactiveCursor: true,
    hideCursorTime: 3000,

    totalTime: durationInMinutes * 60,
    allottedTime: durationInMinutes * 60 * 1000,

    barColor: 'rgb(200, 0, 0)',
    pausedBarColor: 'rgba(200, 0, 0, .6)',

    markdown: {
        smartypants: true
    },

    keyboard: {
        // pause/resume time when Enter is pressed
        13: () => {
            ElapsedTimeBar.isPaused ? ElapsedTimeBar.resume() : ElapsedTimeBar.pause();
        },
        // reset timer when 'r' is pressed
        82: () => {
            ElapsedTimeBar.reset();
        }
    },

    dependencies: [
        { src: 'media/plugins/elapsed-time-bar@18feb15/elapsed-time-bar.js' }
    ],

    plugins: [
        RevealMarkdown,
        RevealHighlight,
        RevealSearch,
        RevealZoom,
        RevealNotes
    ]
});

var clipboard = new ClipboardJS(".hljs", {
    text: function(trigger) {
        return trigger.innerText;
    }
});
var notyf = new Notyf({
    types: [
        {
            type: 'success',
            className: 'notyf-toast-success'
        }
    ]
});
clipboard.on("success", function(e) {
    notyf.success("Copied to clipboard :)");
});
clipboard.on("error", function(e) {
    notyf.error("Can't copy to clipboard :(");
});
</script>

</body>
</html>
